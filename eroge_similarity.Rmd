---
title: "コサイン類似度を用いて似ているエロゲをレコメンドする"
author: ""
date: "2021-02-28"
output: 
  html_document:
    self_contained: false
    lib_dir: libs
    number_sections: false
    toc: false
    toc_depth: 1
    keep_md: false
    css: main.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,include=TRUE,tidy=FALSE,message=FALSE,warning=FALSE,error=FALSE,cache=FALSE)
knitr::opts_chunk$set(out.width="100%",out.height="50%",fig.height=2,fig.align="center")
library(tidyverse)
library(magrittr)
library(knitr)
```

```{r,include=FALSE}
library(here)
```

## 概要

- 批評空間というエロゲレビューサイトのレビューデータを用い、指定したエロゲと似たエロゲをコサイン類似度で探した。いわゆるアイテムベースのレコメンド。
- コサイン類似度を使っただけの機械学習などを用いない簡素な方法だが、体感でそれなりに納得感のある結果が得られた。
- Shinyを用いて[Webアプリ](https://suzuna.shinyapps.io/eroge_recommend/)を実装した。本記事の内容を試すことができる。

## データの取得

批評空間では、春ゲーや冬ゲー、学園ものなど、エロゲの特徴を表すタグ（POVタグと言う）をユーザーがレビューで付けることができる。このPOVタグの数を特徴量ベクトルとみなして、あるゲームとのコサイン類似度を求めることができる。この手法により、あるエロゲと似たエロゲを探す。

批評空間の[SQLを叩けばエロゲデータやレビューデータなどを得られるページ](https://erogamescape.dyndns.org/~ap2/ero/toukei_kaiseki/sql_for_erogamer_index.php)において、以下の右辺のSQLを叩いた結果を一旦csvで保存して、readr::read_csvで左辺のオブジェクトに入れているというイメージ。なお、データを取得したのは2021年の2月末。

```{r,eval=FALSE}
library(tidyverse)
library(lubridate)

# toukei_temp_table: エロゲ名とブランド名、発売日、得点の中央値などが入っているテーブル
# 約24000行
toukei_temp_table <- "SELECT * FROM toukei_temp_table;"
# povlist: POVタグの特徴が入っているテーブル
# 約200行
povlist <- "SELECT id,title,system_group FROM povlist;"
# povgroups: ユーザーがPOVタグをエロゲに付与したデータのテーブル。1行が1レコード
# 約2400000行
povgroups <- "SELECT id,uid,pov,game,rank FROM povgroups;"
```

## データの整形

```{r,include=FALSE}
library(tidyverse)
library(lubridate)

toukei_temp_table <- read_csv(here("data/pov_210224/toukei_temp_table_210224.csv"),locale=locale(encoding="Shift-JIS"))
povgroups <- read_csv(here("data/pov_210224/povgroups_210224.csv"),locale=locale(encoding="Shift-JIS"))
povlist <- read_csv(here("data/pov_210224/povlist_210224.csv"),locale=locale(encoding="Shift-JIS"))
povlist <- povlist %>% 
  select(id,title,system_group)
```

分析対象を以下のエロゲに絞る。

- 商業ゲー（同人ゲーは除く）
- エロゲ（エロゲではない一般ゲーは除く）
- PCゲー
- BLではない（POVタグは男性向けゲームを想定して作られたものが多く、正確に類似度を計算できない恐れがあるため）
- 2000年～2021年に発売されたエロゲ

```{r}
toukei_temp_table_df <- toukei_temp_table %>% 
  # 同人ゲーを除く
  filter(is.na(coterie)) %>% 
  filter(erogame,model=="PC",is.na(boyslove)) %>% 
  select(-coterie,-erogame,-model,-boyslove) %>% 
  filter(between(lubridate::year(sellday),2000,2021)) %>% 
  # 環境の影響でUnicode表記になっている文字を取り除く
  mutate(across(c(gamename,brandname),~str_remove_all(.x,"<U\\+[0-9A-Z]+>")))
```

それぞれ以下のようなdata.frameになる。

```{r}
toukei_temp_table_df %>% 
  head()
povgroups %>% 
  select(-uid) %>% 
  head()
povlist %>% 
  arrange(id) %>% 
  head()
```

POVタグのうち、大分類がシチュエーション、シナリオ、ジャンル、傾向、女の子キャラクター、背景のタグのみに絞る。

```{r}
povlist_used <- povlist %>% 
  filter(system_group %in% c("シチュエーション","シナリオ","ジャンル","傾向","女の子キャラクター","背景")) %>% 
  mutate(pov_title_id=str_c("pov",id,title,sep="_")) %>% 
  select(id,pov_title_id)
```

POVタグの付与数をくっつけたdata.frameを作る。

```{r}
df <- povgroups %>% 
  count(game,pov,name="n") %>% 
  group_by(game) %>% 
  # エロゲに付けられたPOVタグの付与数の合計
  mutate(sum_pov=sum(n)) %>% 
  ungroup() %>% 
  left_join(povlist_used,.,by=c("id"="pov")) %>% 
  select(game,pov_title_id,n,sum_pov) %>% 
  pivot_wider(names_from=pov_title_id,values_from=n,values_fill=list(n=0)) %>% 
  left_join(toukei_temp_table_df,.,by=c("game_id"="game")) %>% 
  arrange(sellday)

# 表示用に一部列を抜粋
df %>% 
  select(gamename,brandname,sellday,sum_pov,starts_with("pov_")) %>% 
  select(1:7) %>% 
  head()
```

POVタグの付与数が少ないエロゲは分析から除外したい。なので、発売年ごとにどの程度POVタグが付いているのか、分布を確認する。

```{r}
df %>% 
  mutate(year=lubridate::year(sellday)) %>% 
  group_by(year) %>% 
  summarize(
    n=n(),
    n_na=sum(is.na(sum_pov)),
    min=min(sum_pov,na.rm=T),
    q_25=quantile(sum_pov,probs=0.25,na.rm=T),
    q_50=quantile(sum_pov,probs=0.5,na.rm=T),
    q_75=quantile(sum_pov,probs=0.75,na.rm=T),
    max=max(sum_pov,na.rm=T)
  ) %>% 
  # RMarkdown上で全部表示したいので
  as.data.frame()
```

とりあえず10個を下回るのを除外すれば良さそう。

```{r}
df <- df %>% 
  filter(sum_pov>=10)
```

## 似たエロゲを探す

上で作ったdfを使って、コサイン類似度を用いて似たエロゲを探す。

```{r}
# 関数を定義する
#' @param x,y vector
calc_cosine_similarity <- function(x,y){
  x%*%y/sqrt(x%*%x * y%*%y)
}

# 二つ以上エロゲを与えることを想定しているが、一つだけエロゲを与える場合もこの関数でカバーできる
suggest_similar_games <- function(pickup_gamename){
  vec <- df %>% 
    filter(gamename %in% pickup_gamename) %>% 
    # pov_で始まる列がPOVタグの付与数なので、その列だけ取り出して特徴量の行列にする
    select(starts_with("pov_")) %>% 
    as.matrix() %>% 
    apply(2,mean)

  df_mat <- df %>% 
    select(starts_with("pov_")) %>% 
    as.matrix()

  apply(df_mat,1,function(x){
    calc_cosine_similarity(vec,x)
  }) %>% 
    add_column(df,cosine_similarity=.,.before=0) %>% 
    filter(!(gamename %in% pickup_gamename)) %>% 
    arrange(desc(cosine_similarity))
}
```

```{r}
# 一つエロゲを与えて似たエロゲを返す
suggest_similar_games("ゆのはな") %>% 
  select(cosine_similarity,gamename,brandname,sellday) %>% 
  head(20)
```

二つ以上エロゲを与える場合は、与えたそれぞれのエロゲの特徴量ベクトルを平均した特徴量ベクトルを作り、それとのコサイン類似度を求める。
```{r}
# 二つ以上エロゲを与えて似たエロゲを返す
suggest_similar_games(c("ゆのはな","Making＊Lovers","こいびとどうしですることぜんぶ")) %>% 
  select(cosine_similarity,gamename,brandname,sellday) %>% 
  head(20)
```

体感的には納得のいく結果である。

## Webアプリの実装

RでWebアプリが作れるShinyで実装した。→[Webアプリ](https://suzuna.shinyapps.io/eroge_recommend/)

selectizeInput()というselectize.jsをバックで動かせるShinyの関数を用いたことで、エロゲ名の一部を入力すると該当するエロゲがサジェストで得られる。エロゲ数が7000本以上にもなり、ブラウザ側でサジェストを動かすと重いので、サーバーサイドで動かした。（[参考](https://shiny.rstudio.com/articles/selectize.html)）
