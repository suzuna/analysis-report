<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="" />

<meta name="date" content="2021-02-28" />

<title>コサイン類似度を用いて似ているエロゲをレコメンドする</title>

<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/navigation-1.1/tabsets.js"></script>
<link href="libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<link rel="stylesheet" href="main.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div id="header">



<h1 class="title toc-ignore">コサイン類似度を用いて似ているエロゲをレコメンドする</h1>
<h4 class="date">2021-02-28</h4>

</div>


<div id="データの取得" class="section level1">
<h1>データの取得</h1>
<p>批評空間の<a href="https://erogamescape.dyndns.org/~ap2/ero/toukei_kaiseki/sql_for_erogamer_index.php">SQLを叩けばエロゲデータやレビューデータなどを得られるページ</a>において、以下の右辺のSQLを叩いた結果を一旦csvで保存して、readr::read_csvで左辺のオブジェクトに入れているというイメージ。なお、データを取得したのは2021年の2月末。</p>
<pre class="r"><code>library(tidyverse)
library(lubridate)

# toukei_temp_table: エロゲ名とブランド名、発売日、得点の中央値などが入っているテーブル
# 約24000行
toukei_temp_table &lt;- &quot;SELECT * FROM toukei_temp_table;&quot;
# povlist: POVタグの特徴が入っているテーブル
# 約200行
povlist &lt;- &quot;SELECT id,title,system_group FROM povlist;&quot;
# povgroups: ユーザーがPOVタグをエロゲに付与したデータのテーブル。1行が1レコード
# 約2400000行
povgroups &lt;- &quot;SELECT id,uid,pov,game,rank FROM povgroups;&quot;</code></pre>
<div id="データの整形" class="section level2">
<h2>データの整形</h2>
<p>分析対象を以下のエロゲに絞る。</p>
<ul>
<li>商業ゲー（同人ゲーは除く）</li>
<li>エロゲ（エロゲではない一般ゲーは除く）</li>
<li>PCゲー</li>
<li>BLではない（POVタグは男性向けゲームを想定して作られたものが多く、正確に類似度を計算できない恐れがあるため）</li>
<li>2000年～2021年に発売されたエロゲ</li>
</ul>
<pre class="r"><code>toukei_temp_table_df &lt;- toukei_temp_table %&gt;% 
  # 同人ゲーを除く
  filter(is.na(coterie)) %&gt;% 
  filter(erogame,model==&quot;PC&quot;,is.na(boyslove)) %&gt;% 
  select(-coterie,-erogame,-model,-boyslove) %&gt;% 
  filter(between(lubridate::year(sellday),2000,2021)) %&gt;% 
  # 環境の影響でUnicode表記になっている文字を取り除く
  mutate(across(c(gamename,brandname),~str_remove_all(.x,&quot;&lt;U\\+[0-9A-Z]+&gt;&quot;)))</code></pre>
<p>それぞれ以下のようなdata.frameになる。</p>
<pre class="r"><code>toukei_temp_table_df %&gt;% 
  head()</code></pre>
<pre><code>## # A tibble: 6 x 10
##   gamename       brandname  sellday median average stddev count allcount game_id
##   &lt;chr&gt;          &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
## 1 HUNTER         AST        2000/1~     28    27.5     25     2        2    1015
## 2 INNOCENTな天使たち~ for        2000/1~     50    49.4     19    14       15      57
## 3 サンクスギビング SPEC~ エクセレンツ~ 2000/1~     20    20       NA     1        1    3573
## 4 依頼人 ～メタモルフォーゼ~ Factor     2000/1~     10    15.5     11     4        7      61
## 5 夕焼け ～November~ Tactics    2000/1~     68    63.3     18    59       71     802
## 6 聖域 ～嘆きのウサギ～~ MESA       2000/1~     30    43.3     32     3        6     377
## # ... with 1 more variable: brand_id &lt;dbl&gt;</code></pre>
<pre class="r"><code>povgroups %&gt;% 
  select(-uid) %&gt;% 
  head()</code></pre>
<pre><code>## # A tibble: 6 x 3
##     pov  game rank 
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;
## 1   513 13576 A    
## 2   359 11004 A    
## 3     1 15937 A    
## 4   253 15937 A    
## 5    51 15937 A    
## 6   235 15967 A</code></pre>
<pre class="r"><code>povlist %&gt;% 
  arrange(id) %&gt;% 
  head()</code></pre>
<pre><code>## # A tibble: 6 x 3
##      id title                                  system_group
##   &lt;dbl&gt; &lt;chr&gt;                                  &lt;chr&gt;       
## 1     1 おかずに使える                         傾向        
## 2     2 後味悪すぎ                             傾向        
## 3     3 ゲーム性のある飽きないゲーム           ゲーム性    
## 4     4 ひたすら長い。長すぎるよ、このゲーム。 時間        
## 5     6 BGMに惚れ惚れ(*&#39;-&#39;)                    音          
## 6     7 インテリなエロゲー                     傾向</code></pre>
<p>POVタグのうち、大分類がシチュエーション、シナリオ、ジャンル、傾向、女の子キャラクター、背景のタグのみに絞る。</p>
<pre class="r"><code>povlist_used &lt;- povlist %&gt;% 
  filter(system_group %in% c(&quot;シチュエーション&quot;,&quot;シナリオ&quot;,&quot;ジャンル&quot;,&quot;傾向&quot;,&quot;女の子キャラクター&quot;,&quot;背景&quot;)) %&gt;% 
  mutate(pov_title_id=str_c(&quot;pov&quot;,id,title,sep=&quot;_&quot;)) %&gt;% 
  select(id,pov_title_id)</code></pre>
<p>POVタグの付与数をくっつけたdata.frameを作る。</p>
<pre class="r"><code>df &lt;- povgroups %&gt;% 
  count(game,pov,name=&quot;n&quot;) %&gt;% 
  group_by(game) %&gt;% 
  # エロゲに付けられたPOVタグの付与数の合計
  mutate(sum_pov=sum(n)) %&gt;% 
  ungroup() %&gt;% 
  left_join(povlist_used,.,by=c(&quot;id&quot;=&quot;pov&quot;)) %&gt;% 
  select(game,pov_title_id,n,sum_pov) %&gt;% 
  pivot_wider(names_from=pov_title_id,values_from=n,values_fill=list(n=0)) %&gt;% 
  left_join(toukei_temp_table_df,.,by=c(&quot;game_id&quot;=&quot;game&quot;)) %&gt;% 
  arrange(sellday)

# 表示用に一部列を抜粋
df %&gt;% 
  select(gamename,brandname,sellday,sum_pov,starts_with(&quot;pov_&quot;)) %&gt;% 
  select(1:7) %&gt;% 
  head()</code></pre>
<pre><code>## # A tibble: 6 x 7
##   gamename      brandname  sellday  sum_pov pov_28_エロゲー初心者にお勧めな~ pov_33_萌えゲー
##   &lt;chr&gt;         &lt;chr&gt;      &lt;chr&gt;      &lt;int&gt;                &lt;int&gt;           &lt;int&gt;
## 1 HUNTER        AST        2000/1/~      NA                   NA              NA
## 2 INNOCENTな天使た~ for        2000/1/~       2                    0               0
## 3 サンクスギビング SPE~ エクセレンツ~ 2000/1/~      NA                   NA              NA
## 4 依頼人 ～メタモルフォー~ Factor     2000/1/~      NA                   NA              NA
## 5 夕焼け ～Novembe~ Tactics    2000/1/~      24                    0               0
## 6 聖域 ～嘆きのウサギ～~ MESA       2000/1/~      NA                   NA              NA
## # ... with 1 more variable: pov_36_ヒロインが朝起こしに来る &lt;int&gt;</code></pre>
<p>POVタグの付与数が少ないエロゲは分析から除外したい。なので、発売年ごとにどの程度POVタグが付いているのか、分布を確認する。</p>
<pre class="r"><code>df %&gt;% 
  mutate(year=lubridate::year(sellday)) %&gt;% 
  group_by(year) %&gt;% 
  summarize(
    n=n(),
    n_na=sum(is.na(sum_pov)),
    min=min(sum_pov,na.rm=T),
    q_25=quantile(sum_pov,probs=0.25,na.rm=T),
    q_50=quantile(sum_pov,probs=0.5,na.rm=T),
    q_75=quantile(sum_pov,probs=0.75,na.rm=T),
    max=max(sum_pov,na.rm=T)
  ) %&gt;% 
  # RMarkdown上で全部表示したいので
  as.data.frame()</code></pre>
<pre><code>##    year   n n_na min  q_25 q_50   q_75   max
## 1  2000 536  179   1  6.00 14.0  36.00  6553
## 2  2001 481   97   1  8.00 20.0  52.25  4519
## 3  2002 544  112   1 10.00 24.0  88.00  7663
## 4  2003 603  118   1 11.00 37.0 120.00 13907
## 5  2004 566   69   1 15.00 46.0 157.00 16775
## 6  2005 546   72   1 14.00 41.5 145.50 17981
## 7  2006 569   93   1 21.00 60.0 159.00 17453
## 8  2007 557   83   1 15.00 50.0 211.75  7744
## 9  2008 538   58   1 24.00 60.0 205.00 16217
## 10 2009 551   62   1 23.00 61.0 201.00 11759
## 11 2010 500   47   1 25.00 69.0 224.00 13382
## 12 2011 506   49   1 24.00 70.0 206.00 12103
## 13 2012 548   68   1 17.00 52.5 163.25  7957
## 14 2013 521   74   1 20.00 49.0 152.00  4687
## 15 2014 573  128   1 14.00 36.0 134.00  3313
## 16 2015 500  138   1 14.00 40.5 127.75  5429
## 17 2016 470  122   1 12.00 33.5 105.00  2411
## 18 2017 443  121   1 16.00 37.0 108.75  2791
## 19 2018 376   93   1 16.00 38.0  82.00  3205
## 20 2019 329  100   1 14.00 33.0  90.00  2106
## 21 2020 309  103   1 13.25 25.0  63.50  1507
## 22 2021  14    6   2  6.25 14.5  19.50   103</code></pre>
<p>とりあえず10個を下回るのを除外すれば良さそう。</p>
<pre class="r"><code>df &lt;- df %&gt;% 
  filter(sum_pov&gt;=10)</code></pre>
</div>
<div id="似たエロゲを探す" class="section level2">
<h2>似たエロゲを探す</h2>
<p>上で作ったdfを使って、コサイン類似度を用いて似たエロゲを探す。</p>
<pre class="r"><code># 関数を定義する
#&#39; @param x,y vector
calc_cosine_similarity &lt;- function(x,y){
  x%*%y/sqrt(x%*%x * y%*%y)
}

# 二つ以上エロゲを与えることを想定しているが、一つだけエロゲを与える場合もこの関数でカバーできる
suggest_similar_games &lt;- function(pickup_gamename){
  vec &lt;- df %&gt;% 
    filter(gamename %in% pickup_gamename) %&gt;% 
    # pov_で始まる列がPOVタグの付与数なので、その列だけ取り出して特徴量の行列にする
    select(starts_with(&quot;pov_&quot;)) %&gt;% 
    as.matrix() %&gt;% 
    apply(2,mean)

  df_mat &lt;- df %&gt;% 
    select(starts_with(&quot;pov_&quot;)) %&gt;% 
    as.matrix()

  apply(df_mat,1,function(x){
    calc_cosine_similarity(vec,x)
  }) %&gt;% 
    add_column(df,cosine_similarity=.,.before=0) %&gt;% 
    filter(!(gamename %in% pickup_gamename)) %&gt;% 
    arrange(desc(cosine_similarity))
}</code></pre>
<pre class="r"><code># 一つエロゲを与えて似たエロゲを返す
suggest_similar_games(&quot;ゆのはな&quot;) %&gt;% 
  select(cosine_similarity,gamename,brandname,sellday) %&gt;% 
  head(20)</code></pre>
<pre><code>## # A tibble: 20 x 4
##    cosine_similarity gamename                      brandname           sellday  
##                &lt;dbl&gt; &lt;chr&gt;                         &lt;chr&gt;               &lt;chr&gt;    
##  1             0.782 しろくまベルスターズ♪         PULLTOP             2009/12/~
##  2             0.773 雪桜 ～ゆきざくら～           D.O.(ディーオー)    2003/11/~
##  3             0.769 SNOW                          Studio Mebius       2003/1/31
##  4             0.744 パティシエなにゃんこ          ぱじゃまソフト      2003/2/28
##  5             0.728 SNOW FULL VOICE VERSION       Studio Mebius       2004/9/24
##  6             0.712 SNOW ～Plus Edition～         Studio Mebius       2006/9/29
##  7             0.706 めぐり、ひとひら。            キャラメルBOX       2003/9/26
##  8             0.703 しゅがてん! -sugarfull tempering-~ Recette             2017/2/24
##  9             0.682 North Wind                    DreamSoft(F&amp;C FC03) 2004/9/24
## 10             0.681 Dear My Friend                light               2004/7/9 
## 11             0.668 青空がっこのせんせい君。      すたじおみりす      2007/1/26
## 12             0.666 とっぱら ～ざしきわらしのはなし～~ キャラメルBOX いちご味~ 2008/9/26
## 13             0.653 Dear My Friend Complete Vers~ light               2005/12/9
## 14             0.650 はるとゆき、                  あかべぇそふとすりぃ~ 2018/7/27
## 15             0.646 杜氏の郷                      ハートブリング      2004/11/~
## 16             0.640 アストラエアの白き永遠        FAVORITE            2014/7/25
## 17             0.637 いろは ～秋の夕日に影ふみを～ Caitsith            2007/7/20
## 18             0.635 ゆきいろ ～空に六花の住む町～ ねこねこソフト      2012/4/27
## 19             0.633 5 -ファイブ-                  RaM                 2008/7/25
## 20             0.624 まいてつ                      Lose                2016/3/25</code></pre>
<pre class="r"><code># 二つ以上エロゲを与えて似たエロゲを返す
suggest_similar_games(c(&quot;ゆのはな&quot;,&quot;Making＊Lovers&quot;,&quot;こいびとどうしですることぜんぶ&quot;)) %&gt;% 
  select(cosine_similarity,gamename,brandname,sellday) %&gt;% 
  head(20)</code></pre>
<pre><code>## # A tibble: 20 x 4
##    cosine_similarity gamename                          brandname        sellday 
##                &lt;dbl&gt; &lt;chr&gt;                             &lt;chr&gt;            &lt;chr&gt;   
##  1             0.838 しろくまベルスターズ♪             PULLTOP          2009/12~
##  2             0.789 雪桜 ～ゆきざくら～               D.O.(ディーオー) 2003/11~
##  3             0.760 パティシエなにゃんこ              ぱじゃまソフト   2003/2/~
##  4             0.759 かみのゆ                          light            2012/2/~
##  5             0.731 Dear My Friend                    light            2004/7/9
##  6             0.723 アマカノ ～Second Season～        あざらしそふと   2015/12~
##  7             0.721 とっぱら ～ざしきわらしのはなし～ キャラメルBOX いちご味~ 2008/9/~
##  8             0.716 しゅがてん! -sugarfull tempering- Recette          2017/2/~
##  9             0.714 SNOW ～Plus Edition～             Studio Mebius    2006/9/~
## 10             0.713 SNOW                              Studio Mebius    2003/1/~
## 11             0.712 アマカノ                          あざらしそふと   2014/12~
## 12             0.711 √ after and another               枕               2007/10~
## 13             0.709 Dear My Friend Complete Version   light            2005/12~
## 14             0.707 千恋＊万花                        ゆずソフト       2016/7/~
## 15             0.705 ゆきこいめると                    FrontWing        2015/3/~
## 16             0.703 ピュア×コネクト                   SMEE             2015/5/~
## 17             0.703 乙女恋心プリスターFANDISC ～もっとHに恋せよ乙女!～~ Escu:de          2010/7/~
## 18             0.698 銀色、遥か                        tone work&#39;s      2016/8/~
## 19             0.689 杜氏の郷                          ハートブリング   2004/11~
## 20             0.686 Sugar*Style                       SMEE             2019/1/~</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
